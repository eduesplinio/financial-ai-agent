// Jest setup file for database package
const { MongoMemoryServer } = require('mongodb-memory-server');

// Sempre defina o ambiente de teste
process.env.NODE_ENV = 'test';

// Aumentar o tempo limite para operações do MongoDB em testes
process.env.MONGODB_SERVER_SELECTION_TIMEOUT = '5000'; // 5 segundos

let mongod;

// Configurar MongoDB em memória antes de todos os testes
beforeAll(async () => {
  // Iniciar o servidor MongoDB em memória
  mongod = await MongoMemoryServer.create();

  // Obter a URI de conexão com o MongoDB em memória
  const uri = mongod.getUri();

  // Configurar variável de ambiente para testes
  process.env.MONGODB_URI = uri;

  console.log(`MongoDB Memory Server iniciado com URI: ${uri}`);
});

// Encerrar o MongoDB em memória após todos os testes
afterAll(async () => {
  if (mongod) {
    await mongod.stop();
    console.log('MongoDB Memory Server encerrado');
  }
});

// Aumentar o timeout para operações de banco de dados
jest.setTimeout(30000);
